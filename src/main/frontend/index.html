<!DOCTYPE html>
<html lang="en">

  <!-- Kiss demo application.  See https://kissweb.org -->

<head>
    <title>Kiss Application</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="normalize.css">
    <link rel="stylesheet" href="normalize2.css">

    <link rel="stylesheet" href="kiss/Utils.css">

    <link rel="stylesheet" href="lib/ag-grid.min.css">
    <link rel="stylesheet" href="lib/ag-theme-balham.min.css">


    <style>

        html, body {
            width: 100%;
            box-sizing: border-box;
            background-color: #b7e4ff;
        }

        label {
            margin-top: 3px;
        }

        .center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translateX(-50%) translateY(-50%);
        }

        input[type=button], input[type=checkbox], input[type=radio], select {
            cursor: pointer;
        }

    </style>

    <script>

        function getScript(url) {
            return new Promise(function (resolve, reject) {
                const head = document.getElementsByTagName("head")[0];
                const script = document.createElement("script");
                script.src = url;

                // Handle Script loading
                {
                    let done = false;

                    // Attach handlers for all browsers
                    script.onload = script.onreadystatechange = function () {
                        if (!done && (!this.readyState ||  this.readyState === "loaded" || this.readyState === "complete")) {
                            done = true;
                            // Handle memory leak in IE
                            script.onload = script.onreadystatechange = null;
                            resolve();
                        } else {
                            console.log("getScript:  error loading " + url);
                            reject();
                        }
                    };
                    script.onerror = function () {
                        console.log("getScript: error loading " + url);
                        reject();
                    };
                }
                head.appendChild(script);
            });
        }

        function getURLParameter(sParam) {
            const urlArgs = window.location.search.substring(1);
            const argArray = urlArgs.split('&');
            for (let i = 0; i < argArray.length; i++)  {
                let param = argArray[i].split('=');
                if (param[0] === sParam)
                    return param[1];
            }
            return undefined;
        }

        function startup() {

            // cache control
            const softwareVersion = "20201108";   // version of the entire system
            const controlCache = true;            // normally true but use false during debugging

            const afterLoad = function () {
                Utils.softwareVersion = softwareVersion;
                Utils.controlCache = controlCache;
                loadScript("index.js", function () {
                    // do nothing
                });
            };

            let numLoaded = 0;

            const loadScript = function (script, fun) {
                if (fun)
                    getScript(script + (controlCache ? '?ver=' + softwareVersion : '')).then(fun);
                else {
                    numLoaded++;
                    getScript(script + (controlCache ? '?ver=' + softwareVersion : '')).then(function () {
                        if (!--numLoaded)
                            afterLoad();
                    });
                }
            };

            const loadUtils = function () {
                loadScript("kiss/Utils.js");
                loadScript("kiss/DateUtils.js");
                loadScript("kiss/DateTimeUtils.js");
                loadScript("kiss/TimeUtils.js");
                loadScript("kiss/NumberUtils.js");
                loadScript("kiss/Server.js");
                loadScript("kiss/AGGrid.js");
            };

            $.ajaxSetup({ cache: controlCache });  // utilize browser cache to the fullest when version hasn't changed

            if (controlCache) {
                const now = getURLParameter("now");
                let urlArgs = window.location.search.substring(1);
                if (now) {
                    const diff = Math.abs(((new Date()).getTime() - Number(now)) / 1000);
                    if (diff > 30) {
                        window.onbeforeunload = null;
                        urlArgs = urlArgs.replaceAll(/now=[^&]*&*/g, '');
                        window.location.href = 'index.html?now=' + (new Date()).getTime() + (urlArgs ? '&' + urlArgs : '');
                    } else {
                        loadUtils();
                    }
                } else {
                    window.onbeforeunload = null;
                    window.location.href = 'index.html?now=' + (new Date()).getTime() + (urlArgs ? '&' + urlArgs : '');
                }
            } else
                loadUtils();
        }

    </script>

</head>

<body onload="startup()">

<script src="lib/jquery-3.6.3.min.js"></script>
<script src="lib/ag-grid-community.noStyle.min.js"></script>

</body>

</html>
